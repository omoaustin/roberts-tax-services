<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="Robert's Tax Services â€” Client Manager">
  <title>Robert's Tax Services</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
  <style>
    /* ============================================================
       DARK THEME (default)
    ============================================================ */
    :root {
      --bg:               #0A0A0A;
      --surface:          #141414;
      --surface-2:        #1C1C1C;
      --border:           rgba(255, 255, 255, 0.07);
      --border-strong:    rgba(255, 255, 255, 0.12);
      --text-primary:     #F5F5F5;
      --text-secondary:   #666666;
      --text-tertiary:    #3D3D3D;
      --green:            #22C55E;
      --green-dim:        rgba(34, 197, 94, 0.12);
      --green-text:       #4ADE80;
      --red:              #EF4444;
      --red-dim:          rgba(239, 68, 68, 0.12);
      --red-text:         #F87171;
      --amber:            #F59E0B;
      --amber-dim:        rgba(245, 158, 11, 0.12);
      --amber-text:       #FCD34D;
      --purple:           #A855F7;
      --purple-dim:       rgba(168, 85, 247, 0.12);
      --purple-text:      #C084FC;
      --blue-dim:         rgba(255, 255, 255, 0.08);
      --blue-text:        #A3A3A3;
      --header-height:    56px;
      --nav-height:       62px;
    }

    /* ============================================================
       LIGHT THEME OVERRIDES
    ============================================================ */
    [data-theme="light"] {
      --bg:               #F5F5F5;
      --surface:          #FFFFFF;
      --surface-2:        #EBEBEB;
      --border:           rgba(0, 0, 0, 0.08);
      --border-strong:    rgba(0, 0, 0, 0.14);
      --text-primary:     #0A0A0A;
      --text-secondary:   #737373;
      --text-tertiary:    #C4C4C4;
      --green:            #16A34A;
      --green-dim:        rgba(22, 163, 74, 0.10);
      --green-text:       #15803D;
      --red:              #DC2626;
      --red-dim:          rgba(220, 38, 38, 0.08);
      --red-text:         #B91C1C;
      --amber:            #D97706;
      --amber-dim:        rgba(217, 119, 6, 0.10);
      --amber-text:       #B45309;
      --purple:           #9333EA;
      --purple-dim:       rgba(147, 51, 234, 0.08);
      --purple-text:      #7E22CE;
      --blue-dim:         rgba(0, 0, 0, 0.05);
      --blue-text:        #525252;
    }

    /* ============================================================
       RESET & BASE
    ============================================================ */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      background: var(--bg);
    }

    body {
      font-family: 'Playfair Display', Georgia, "Times New Roman", serif;
      font-size: 16px;
      line-height: 1.5;
      color: var(--text-primary);
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
      transition: background 0.2s, color 0.2s;
    }

    button {
      font-family: inherit;
      font-size: inherit;
      cursor: pointer;
      touch-action: manipulation;
      border: none;
      background: none;
      color: inherit;
    }

    input, textarea {
      font-family: inherit;
      color: var(--text-primary);
    }

    /* ============================================================
       APP SHELL
    ============================================================ */
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
    }

    /* --- Header --- */
    #app-header {
      flex-shrink: 0;
      height: var(--header-height);
      padding-top: env(safe-area-inset-top);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding-left: 20px;
      padding-right: 16px;
      padding-bottom: 12px;
      transition: background 0.2s, border-color 0.2s;
    }

    .logo-mark {
      display: flex;
      align-items: center;
    }

    .logo-letters {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--green);
      line-height: 1;
    }

    /* --- Theme Toggle --- */
    #theme-toggle {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--surface-2);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: var(--text-primary);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      transition: background 0.15s;
      line-height: 1;
    }

    #theme-toggle:active {
      background: var(--border-strong);
    }

    /* --- View Container --- */
    #view-container {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
      background: var(--bg);
      transition: background 0.2s;
    }

    /* --- Bottom Navigation --- */
    #bottom-nav {
      flex-shrink: 0;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      height: var(--nav-height);
      padding-bottom: env(safe-area-inset-bottom);
      background: var(--surface);
      border-top: 1px solid var(--border);
      transition: background 0.2s, border-color 0.2s;
    }

    .nav-tab {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      min-height: 44px;
      color: var(--text-secondary);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      transition: color 0.15s;
    }

    .nav-tab.active {
      color: var(--green);
    }

    .nav-icon {
      font-size: 19px;
      line-height: 1;
    }

    .nav-label {
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.01em;
    }

    /* ============================================================
       VIEWS
    ============================================================ */
    .view {
      display: none;
      min-height: 100%;
    }

    .view.active {
      display: block;
    }

    /* ============================================================
       SHARED COMPONENTS
    ============================================================ */

    .section-header {
      padding: 24px 20px 10px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* Badge */
    .badge {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .badge-paid    { background: var(--green-dim);   color: var(--green-text); }
    .badge-unpaid  { background: var(--red-dim);     color: var(--red-text); }
    .badge-partial { background: var(--amber-dim);   color: var(--amber-text); }
    .badge-ext     { background: var(--purple-dim);  color: var(--purple-text); }
    .badge-filed   { background: var(--blue-dim);    color: var(--blue-text); }

    /* Primary button */
    .btn-primary {
      width: 100%;
      height: 50px;
      background: var(--green);
      color: #FFFFFF;
      font-size: 15px;
      font-weight: 600;
      border-radius: 12px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      letter-spacing: -0.01em;
      transition: opacity 0.15s;
    }

    [data-theme="dark"] .btn-primary {
      color: #000000;
    }

    .btn-primary:active {
      opacity: 0.85;
    }

    .btn-primary:disabled {
      background: var(--surface-2);
      color: var(--text-secondary);
    }

    /* Danger button */
    .btn-danger {
      width: 100%;
      height: 50px;
      background: var(--red-dim);
      color: var(--red-text);
      font-size: 15px;
      font-weight: 600;
      border-radius: 12px;
      border: 1px solid var(--red-dim);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: opacity 0.15s;
    }

    .btn-danger:active {
      opacity: 0.75;
    }

    /* Text input */
    .text-input {
      width: 100%;
      height: 50px;
      padding: 0 14px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface-2);
      color: var(--text-primary);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      transition: border-color 0.15s, background 0.2s;
    }

    .text-input::placeholder {
      color: var(--text-tertiary);
    }

    .text-input:focus {
      border-color: var(--green);
    }

    /* ============================================================
       DASHBOARD VIEW
    ============================================================ */
    #view-dashboard {
      padding-bottom: 24px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 16px 20px;
    }

    @media (min-width: 768px) {
      .metrics-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .metric-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px 16px;
      transition: background 0.2s, border-color 0.2s;
    }

    .metric-card.highlight {
      background: var(--green-dim);
      border-color: rgba(34, 197, 94, 0.2);
    }

    [data-theme="light"] .metric-card.highlight {
      border-color: rgba(22, 163, 74, 0.2);
    }

    .metric-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.1;
      letter-spacing: -0.03em;
    }

    .metric-card.highlight .metric-value {
      color: var(--green);
    }

    .metric-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-top: 5px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Progress */
    .progress-wrap {
      margin: 0 20px;
    }

    .progress-bar-bg {
      height: 6px;
      background: var(--surface-2);
      border-radius: 999px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--green);
      border-radius: 999px;
    }

    .progress-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    /* List card (activity, retention) */
    .list-card {
      margin: 0 20px;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      background: var(--surface);
      transition: background 0.2s, border-color 0.2s;
    }

    .list-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      gap: 12px;
      transition: border-color 0.2s;
    }

    .list-row:last-child {
      border-bottom: none;
    }

    .row-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .row-meta {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .stat-number {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    /* ============================================================
       CLIENTS VIEW
    ============================================================ */
    .search-bar-wrap {
      padding: 12px 20px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      transition: background 0.2s, border-color 0.2s;
    }

    .search-wrap {
      position: relative;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      font-size: 15px;
      pointer-events: none;
    }

    .search-input {
      width: 100%;
      height: 42px;
      padding: 0 14px 0 38px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--surface-2);
      color: var(--text-primary);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      transition: border-color 0.15s, background 0.2s;
    }

    .search-input::placeholder {
      color: var(--text-tertiary);
    }

    .search-input:focus {
      border-color: var(--green);
    }

    .filter-row {
      display: flex;
      gap: 8px;
      padding: 10px 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      background: var(--bg);
      transition: background 0.2s;
    }

    .filter-row::-webkit-scrollbar { display: none; }

    .filter-chip {
      flex-shrink: 0;
      height: 32px;
      padding: 0 14px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: var(--surface);
      white-space: nowrap;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
    }

    .filter-chip.active {
      border-color: var(--green);
      color: var(--green);
      background: var(--green-dim);
    }

    .alpha-header {
      padding: 8px 20px 4px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-secondary);
      background: var(--bg);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      transition: background 0.2s;
    }

    .client-list {
      background: var(--surface);
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      transition: background 0.2s, border-color 0.2s;
    }

    .client-row {
      display: flex;
      align-items: center;
      min-height: 60px;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      gap: 12px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: border-color 0.2s;
    }

    .client-row:last-child {
      border-bottom: none;
    }

    .client-info {
      flex: 1;
    }

    .client-name {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .client-sub {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .client-chevron {
      color: var(--text-tertiary);
      font-size: 18px;
      font-weight: 300;
    }

    .clients-footer {
      padding: 20px;
      text-align: center;
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* ============================================================
       ASK AI VIEW
    ============================================================ */
    #view-ask-ai {
      padding: 20px;
      display: none;
      flex-direction: column;
      gap: 16px;
    }

    #view-ask-ai.active {
      display: flex;
    }

    .ai-warning {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 14px 16px;
      background: var(--amber-dim);
      border: 1px solid rgba(245, 158, 11, 0.2);
      border-radius: 12px;
      font-size: 14px;
      color: var(--amber-text);
    }

    [data-theme="light"] .ai-warning {
      border-color: rgba(217, 119, 6, 0.2);
    }

    .ai-warning-icon {
      font-size: 16px;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .ai-textarea {
      width: 100%;
      min-height: 110px;
      padding: 14px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface);
      color: var(--text-primary);
      resize: none;
      outline: none;
      -webkit-appearance: none;
      transition: border-color 0.15s, background 0.2s;
      line-height: 1.5;
    }

    .ai-textarea::placeholder {
      color: var(--text-tertiary);
    }

    .ai-textarea:focus {
      border-color: var(--green);
    }

    .ai-response-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      font-size: 15px;
      color: var(--text-secondary);
      min-height: 90px;
      line-height: 1.6;
      transition: background 0.2s, border-color 0.2s;
    }

    .example-chips {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .example-chip {
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      color: var(--text-secondary);
      text-align: left;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: border-color 0.15s, color 0.15s, background 0.2s;
    }

    .example-chip:active {
      border-color: var(--green);
      color: var(--green);
      background: var(--green-dim);
    }

    /* ============================================================
       SETTINGS VIEW
    ============================================================ */
    #view-settings {
      padding-bottom: 40px;
    }

    .settings-group {
      margin: 0 20px;
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      background: var(--surface);
      transition: background 0.2s, border-color 0.2s;
    }

    .settings-row {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      transition: border-color 0.2s;
    }

    .settings-row:last-child {
      border-bottom: none;
    }

    .settings-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .settings-note {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 8px;
      line-height: 1.5;
    }

    .api-key-status {
      font-size: 13px;
      font-weight: 500;
      margin-top: 10px;
    }

    .api-key-input-wrap {
      position: relative;
    }

    .api-key-input-wrap .text-input {
      padding-right: 72px;
    }

    .api-key-show-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      height: 30px;
      padding: 0 10px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      font-family: inherit;
      transition: color 0.15s, border-color 0.15s;
    }

    .api-key-show-btn:active { opacity: 0.6; }

    .api-key-btn-row {
      display: flex;
      gap: 12px;
    }

    .api-key-btn-row .btn-primary,
    .api-key-btn-row .btn-danger {
      flex: 1;
    }

    .about-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 15px;
      color: var(--text-primary);
      transition: border-color 0.2s;
    }

    .about-row:last-child {
      border-bottom: none;
    }

    .about-value {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* ============================================================
       THEME TOGGLE ROW (in Settings)
    ============================================================ */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 16px;
      border-bottom: 1px solid var(--border);
    }

    .toggle-row:last-child {
      border-bottom: none;
    }

    .toggle-label {
      font-size: 15px;
      color: var(--text-primary);
    }

    .pill-toggle {
      width: 50px;
      height: 28px;
      border-radius: 999px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      position: relative;
      cursor: pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.2s, border-color 0.2s;
      flex-shrink: 0;
    }

    .pill-toggle.on {
      background: var(--green);
      border-color: transparent;
    }

    .pill-knob {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--text-secondary);
      top: 3px;
      left: 3px;
      transition: transform 0.2s, background 0.2s;
    }

    .pill-toggle.on .pill-knob {
      transform: translateX(22px);
      background: #000000;
    }

    [data-theme="light"] .pill-toggle.on .pill-knob {
      background: #FFFFFF;
    }

    /* ============================================================
       DATA STATUS BANNER
    ============================================================ */
    #data-status-banner {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s, border-color 0.2s;
    }

    #data-status-banner.loading {
      display: flex;
      background: var(--blue-dim);
      color: var(--blue-text);
    }

    #data-status-banner.error {
      display: flex;
      background: var(--red-dim);
      color: var(--red-text);
      border-color: rgba(239, 68, 68, 0.2);
    }

    [data-theme="light"] #data-status-banner.error {
      border-color: rgba(220, 38, 38, 0.15);
    }

    .status-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid currentColor;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-text {
      flex: 1;
    }

    #refresh-btn {
      height: 30px;
      padding: 0 14px;
      border: 1px solid currentColor;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      color: inherit;
      background: transparent;
      flex-shrink: 0;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      opacity: 0.8;
      font-family: inherit;
    }

    #refresh-btn:active { opacity: 0.5; }
    #refresh-btn:disabled { opacity: 0.35; }
  </style>
</head>
<body>

<div id="app">

  <!-- ==================== HEADER ==================== -->
  <header id="app-header">
    <div class="logo-mark">
      <span class="logo-letters">PR</span>
    </div>
    <button id="theme-toggle" aria-label="Switch to light mode">â˜€</button>
  </header>

  <!-- ==================== VIEWS ==================== -->
  <main id="view-container">

    <!-- DASHBOARD -->
    <section id="view-dashboard" class="view active">
      <div id="data-status-banner" role="status" aria-live="polite">
        <div class="status-spinner" id="status-spinner"></div>
        <span class="status-text" id="status-text">Loading client data...</span>
        <button id="refresh-btn">Refresh</button>
      </div>

      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-value" id="metric-total">â€”</div>
          <div class="metric-label">Total Clients</div>
        </div>
        <div class="metric-card highlight">
          <div class="metric-value" id="metric-collected">â€”</div>
          <div class="metric-label">Collected</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="metric-outstanding">â€”</div>
          <div class="metric-label">Outstanding</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="metric-extensions">â€”</div>
          <div class="metric-label">Amendments</div>
        </div>
      </div>

      <div class="section-header">Season Progress</div>
      <div class="progress-wrap">
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" id="progress-fill" style="width: 0%;"></div>
        </div>
        <div class="progress-label" id="progress-label">Loading...</div>
      </div>

      <div class="section-header">Recent Activity</div>
      <div class="list-card" id="activity-list">
        <div class="list-row">
          <div>
            <div class="row-name">Anderson, James</div>
            <div class="row-meta">Payment received Â· Today</div>
          </div>
          <span class="badge badge-paid">Paid</span>
        </div>
        <div class="list-row">
          <div>
            <div class="row-name">Baker, Patricia</div>
            <div class="row-meta">Extension filed Â· Yesterday</div>
          </div>
          <span class="badge badge-ext">Extension</span>
        </div>
        <div class="list-row">
          <div>
            <div class="row-name">Chen, David</div>
            <div class="row-meta">Return filed Â· Feb 17</div>
          </div>
          <span class="badge badge-filed">Filed</span>
        </div>
        <div class="list-row">
          <div>
            <div class="row-name">Martinez, Sofia</div>
            <div class="row-meta">Awaiting payment Â· Feb 15</div>
          </div>
          <span class="badge badge-unpaid">Unpaid</span>
        </div>
        <div class="list-row">
          <div>
            <div class="row-name">Thompson, Robert</div>
            <div class="row-meta">Partial payment Â· Feb 14</div>
          </div>
          <span class="badge badge-partial">Partial</span>
        </div>
      </div>

      <div class="section-header">Retention</div>
      <div class="list-card">
        <div class="list-row">
          <div class="row-name">Returning Clients</div>
          <span class="stat-number" id="retention-returning" style="color: var(--green);">â€”</span>
        </div>
        <div class="list-row">
          <div class="row-name">New Clients</div>
          <span class="stat-number" id="retention-new" style="color: var(--text-primary);">â€”</span>
        </div>
        <div class="list-row">
          <div class="row-name">Did Not Return</div>
          <span class="stat-number" id="retention-not-returned" style="color: var(--text-secondary);">â€”</span>
        </div>
      </div>
    </section>

    <!-- CLIENTS -->
    <section id="view-clients" class="view">
      <div class="search-bar-wrap">
        <div class="search-wrap">
          <span class="search-icon">&#128269;</span>
          <input
            type="search"
            id="client-search-input"
            class="search-input"
            placeholder="Search clients..."
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
          >
        </div>
      </div>

      <div class="filter-row">
        <button class="filter-chip active" data-filter="all">All</button>
        <button class="filter-chip" data-filter="unpaid">Unpaid</button>
        <button class="filter-chip" data-filter="amendment">Amendment</button>
        <button class="filter-chip" data-filter="returning">Returning</button>
        <button class="filter-chip" data-filter="new">New</button>
      </div>

      <div id="client-list-container"></div>
    </section>

    <!-- ASK AI -->
    <section id="view-ask-ai" class="view">
      <div id="ai-key-warning" class="ai-warning" style="display:none;">
        <span class="ai-warning-icon">&#9888;</span>
        <span>Add your Anthropic API key in <strong>Settings</strong> to enable AI queries.</span>
      </div>

      <textarea
        id="ai-query-input"
        class="ai-textarea"
        placeholder="Ask a question about your clients..."
        rows="4"
      ></textarea>

      <button id="ai-send-btn" class="btn-primary" disabled>Ask Claude</button>

      <div class="section-header" style="padding-left:0;padding-top:4px;">Response</div>
      <div id="ai-response-box" class="ai-response-box">
        Your answer will appear here.
      </div>

      <div class="section-header" style="padding-left:0;">Try asking...</div>
      <div class="example-chips">
        <button class="example-chip" data-query="Who hasn't paid yet?">"Who hasn't paid yet?"</button>
        <button class="example-chip" data-query="How many clients need amendments?">"How many clients need amendments?"</button>
        <button class="example-chip" data-query="Which clients didn't return this year?">"Which clients didn't return this year?"</button>
        <button class="example-chip" data-query="What's my total outstanding balance?">"What's my total outstanding balance?"</button>
        <button class="example-chip" data-query="Who paid this week?">"Who paid this week?"</button>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="view-settings" class="view">

      <div class="section-header">Appearance</div>
      <div class="settings-group">
        <div class="toggle-row">
          <span class="toggle-label">Light Mode</span>
          <button id="settings-theme-toggle" class="pill-toggle" aria-label="Toggle light mode" role="switch" aria-checked="false">
            <div class="pill-knob"></div>
          </button>
        </div>
      </div>

      <div class="section-header">Anthropic API Key</div>
      <div class="settings-group">
        <div class="settings-row">
          <div class="settings-label">API Key</div>
          <div class="api-key-input-wrap">
            <input
              type="password"
              id="api-key-input"
              class="text-input"
              placeholder="sk-ant-..."
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              spellcheck="false"
            >
            <button id="api-key-show-btn" class="api-key-show-btn" type="button" aria-label="Show API key">Show</button>
          </div>
          <div class="settings-note">Stored locally on this device only. Never sent to any server other than Anthropic.</div>
          <div id="api-key-status" class="api-key-status"></div>
        </div>
        <div class="settings-row api-key-btn-row">
          <button id="api-key-save-btn" class="btn-primary">Save Key</button>
          <button id="api-key-clear-btn" class="btn-danger">Clear Key</button>
        </div>
      </div>

      <div class="section-header">Data Source</div>
      <div class="settings-group">
        <div class="about-row">
          <span>Google Sheet</span>
          <span class="about-value">Not connected</span>
        </div>
        <div class="about-row">
          <span>Last Synced</span>
          <span class="about-value">â€”</span>
        </div>
      </div>

      <div class="section-header">About</div>
      <div class="settings-group">
        <div class="about-row">
          <span>App</span>
          <span class="about-value">Robert's Tax Services</span>
        </div>
        <div class="about-row">
          <span>Version</span>
          <span class="about-value">1.0.0</span>
        </div>
        <div class="about-row">
          <span>Device</span>
          <span class="about-value">iPad Safari</span>
        </div>
      </div>

    </section>

  </main>

  <!-- ==================== BOTTOM NAV ==================== -->
  <nav id="bottom-nav">
    <button class="nav-tab active" data-view="dashboard" data-label="Dashboard">
      <span class="nav-icon">&#9783;</span>
      <span class="nav-label">Dashboard</span>
    </button>
    <button class="nav-tab" data-view="clients" data-label="Clients">
      <span class="nav-icon">&#128101;</span>
      <span class="nav-label">Clients</span>
    </button>
    <button class="nav-tab" data-view="ask-ai" data-label="Ask AI">
      <span class="nav-icon">&#128172;</span>
      <span class="nav-label">Ask AI</span>
    </button>
    <button class="nav-tab" data-view="settings" data-label="Settings">
      <span class="nav-icon">&#9881;</span>
      <span class="nav-label">Settings</span>
    </button>
  </nav>

</div>

<script>
  // ============================================================
  // SECTION 1: CONSTANTS & STATE
  // ============================================================

  const VIEWS = {
    DASHBOARD: 'dashboard',
    CLIENTS:   'clients',
    ASK_AI:    'ask-ai',
    SETTINGS:  'settings',
  };

  const STORAGE_KEYS = {
    API_KEY: 'rts_anthropic_api_key',
    THEME:   'rts_theme',
  };

  // Google Sheets connection â€” replace locally before testing, never commit real values
  const SHEETS_API_KEY = 'YOUR_GOOGLE_SHEETS_API_KEY_HERE'; // replace locally, never commit
  const SHEET_ID       = '1-BLWPTF-JME8bP0dadZ8L6ZoUdLANu8QH-HQ14Hj7Mw';

  // App state
  let currentView = VIEWS.DASHBOARD;
  let clientData  = [];    // populated by loadData()
  let lastSynced  = null;  // Date of last successful fetch
  let isFetching  = false; // guard against overlapping fetch calls
  let activeFilter = 'all'; // active client list filter chip

  // ============================================================
  // SECTION 2: VIEW SWITCHING
  // ============================================================

  function showView(viewId) {
    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));

    const target = document.getElementById('view-' + viewId);
    if (target) target.classList.add('active');

    document.querySelectorAll('.nav-tab').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.view === viewId);
    });

    currentView = viewId;
  }

  // ============================================================
  // SECTION 3: THEME
  // ============================================================

  function getTheme() {
    return localStorage.getItem(STORAGE_KEYS.THEME) || 'dark';
  }

  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(STORAGE_KEYS.THEME, theme);

    // Header toggle button
    const headerBtn = document.getElementById('theme-toggle');
    if (headerBtn) {
      headerBtn.textContent = theme === 'dark' ? 'â˜€' : 'ðŸŒ™';
      headerBtn.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
    }

    // Settings pill toggle
    const pill = document.getElementById('settings-theme-toggle');
    if (pill) {
      const isLight = theme === 'light';
      pill.classList.toggle('on', isLight);
      pill.setAttribute('aria-checked', String(isLight));
    }
  }

  function toggleTheme() {
    applyTheme(getTheme() === 'dark' ? 'light' : 'dark');
  }

  function initTheme() {
    applyTheme(getTheme());

    document.getElementById('theme-toggle')
      ?.addEventListener('click', toggleTheme);

    document.getElementById('settings-theme-toggle')
      ?.addEventListener('click', toggleTheme);
  }

  // ============================================================
  // SECTION 4: LOCAL STORAGE (API KEY)
  // ============================================================

  function getApiKey() {
    return localStorage.getItem(STORAGE_KEYS.API_KEY) || '';
  }

  function saveApiKey(key) {
    const trimmed = (key || '').trim();
    if (trimmed) {
      localStorage.setItem(STORAGE_KEYS.API_KEY, trimmed);
    } else {
      localStorage.removeItem(STORAGE_KEYS.API_KEY);
    }
  }

  function hasApiKey() {
    return getApiKey().length > 0;
  }

  // ============================================================
  // SECTION 5: SETTINGS
  // ============================================================

  function initSettings() {
    const input    = document.getElementById('api-key-input');
    const saveBtn  = document.getElementById('api-key-save-btn');
    const clearBtn = document.getElementById('api-key-clear-btn');
    const showBtn  = document.getElementById('api-key-show-btn');
    const status   = document.getElementById('api-key-status');

    if (!input || !saveBtn) return;

    input.value = getApiKey();
    renderApiKeyStatus(status);

    // Show/hide API key toggle
    showBtn?.addEventListener('click', () => {
      const revealing = input.type === 'password';
      input.type = revealing ? 'text' : 'password';
      if (showBtn) showBtn.textContent = revealing ? 'Hide' : 'Show';
    });

    // Enter key saves the key and dismisses keyboard
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        saveApiKey(input.value);
        renderApiKeyStatus(status);
        updateAiView();
        input.blur();
      }
    });

    saveBtn.addEventListener('click', () => {
      saveApiKey(input.value);
      renderApiKeyStatus(status);
      updateAiView();
    });

    clearBtn.addEventListener('click', () => {
      saveApiKey('');
      input.value = '';
      input.type = 'password';
      if (showBtn) showBtn.textContent = 'Show';
      renderApiKeyStatus(status);
      updateAiView();
    });
  }

  function renderApiKeyStatus(el) {
    if (!el) return;
    if (hasApiKey()) {
      el.textContent = 'âœ“ API key saved';
      el.style.color = 'var(--green)';
    } else {
      el.textContent = 'No API key saved';
      el.style.color = 'var(--text-secondary)';
    }
  }

  // ============================================================
  // SECTION 6: ASK AI VIEW
  // ============================================================

  function initAskAi() {
    const textarea = document.getElementById('ai-query-input');
    const sendBtn  = document.getElementById('ai-send-btn');

    // Example chips populate the textarea
    document.querySelectorAll('.example-chip').forEach(btn => {
      btn.addEventListener('click', () => {
        if (textarea) {
          textarea.value = btn.dataset.query;
          textarea.focus();
        }
      });
    });

    // Send button click
    sendBtn?.addEventListener('click', () => {
      const query = (textarea?.value || '').trim();
      if (query) handleAskClaude(query);
    });

    // Cmd/Ctrl + Enter to submit
    textarea?.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const query = (textarea.value || '').trim();
        if (query) handleAskClaude(query);
      }
    });

    updateAiView();
  }

  function updateAiView() {
    const warning = document.getElementById('ai-key-warning');
    const sendBtn = document.getElementById('ai-send-btn');
    const hasKey  = hasApiKey();

    if (warning) warning.style.display = hasKey ? 'none' : 'flex';
    if (sendBtn) sendBtn.disabled = !hasKey;
  }

  async function handleAskClaude(query) {
    const responseBox = document.getElementById('ai-response-box');
    const sendBtn     = document.getElementById('ai-send-btn');
    if (!responseBox) return;

    // Loading state
    if (sendBtn) sendBtn.disabled = true;
    responseBox.innerHTML = '<span style="color:var(--text-secondary)">Thinking...</span>';

    try {
      const answer = await askClaude(query);
      // Render response â€” escape HTML, then restore line breaks
      responseBox.innerHTML = escHtml(answer).replace(/\n/g, '<br>');
    } catch (err) {
      responseBox.innerHTML =
        '<span style="color:var(--red)">' + escHtml(err.message || 'Something went wrong.') + '</span>';
    } finally {
      if (sendBtn) sendBtn.disabled = !hasApiKey();
    }
  }

  async function askClaude(query) {
    const apiKey = getApiKey();
    if (!apiKey) throw new Error('No API key set â€” add your key in Settings.');

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'x-api-key':         apiKey,
        'anthropic-version': '2023-06-01',
        'content-type':      'application/json',
      },
      body: JSON.stringify({
        model:      'claude-haiku-4-5-20251001',
        max_tokens: 1024,
        system:     buildSystemPrompt(),
        messages:   [{ role: 'user', content: query }],
      }),
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      if (response.status === 401) throw new Error('Invalid API key â€” check your key in Settings.');
      if (response.status === 429) throw new Error('Rate limit reached â€” wait a moment and try again.');
      throw new Error(err.error?.message || 'API error ' + response.status);
    }

    const data = await response.json();
    return data.content?.[0]?.text || '(No response received)';
  }

  function buildSystemPrompt() {
    const today = new Date().toLocaleDateString('en-US', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
    });

    if (!clientData.length) {
      return `You are a helpful assistant for a solo tax preparer named Robert. Today is ${today}. No client data is currently loaded â€” tell the user to refresh the app.`;
    }

    const total       = clientData.length;
    const collected   = clientData.reduce((s, c) => s + c.amountPaid, 0);
    const outstanding = clientData.reduce((s, c) => s + Math.max(0, c.paymentAmount - c.amountPaid), 0);

    // Compact tab-separated table for context
    const header = 'Name\tStatus\tOwed\tPaid\tPayment Date\tClient Type\tWas Last Year\tAmendment Needed\tAmendment Filed\tExtended Deadline\tNotes';
    const rows = clientData.map(c => [
      c.name,
      c.paymentStatus,
      '$' + c.paymentAmount,
      '$' + c.amountPaid,
      c.paymentDate   || 'â€”',
      c.isReturning   ? 'Returning' : 'New',
      c.wasLastYear   ? 'Yes' : 'No',
      c.extensionNeeded  ? 'Yes' : 'No',
      c.extensionFiled   ? 'Yes' : 'No',
      c.extendedDeadline || 'â€”',
      c.notes || '',
    ].join('\t')).join('\n');

    return `You are a helpful assistant for a solo tax preparer named Robert. Today is ${today}.

You have access to data for ${total} clients this tax season.
Total collected: $${Math.round(collected).toLocaleString('en-US')}
Total outstanding: $${Math.round(outstanding).toLocaleString('en-US')}

Client data (tab-separated):
${header}
${rows}

Answer Robert's questions about his clients concisely and helpfully. When listing clients, format them clearly. Use dollar amounts where relevant. For time-sensitive questions (e.g. "this week"), use today's date as your reference.`;
  }

  // ============================================================
  // SECTION 7: NAVIGATION
  // ============================================================

  function initNavigation() {
    document.querySelectorAll('.nav-tab').forEach(btn => {
      btn.addEventListener('click', () => showView(btn.dataset.view));
    });
  }

  // ============================================================
  // SECTION 8: FILTER CHIPS
  // ============================================================

  function initFilterChips() {
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        activeFilter = chip.dataset.filter || 'all';
        renderClientList();
      });
    });
  }

  function initClientSearch() {
    document.getElementById('client-search-input')
      ?.addEventListener('input', () => renderClientList());
  }

  // ============================================================
  // SECTION 9: INIT
  // ============================================================

  function init() {
    initTheme();
    initNavigation();
    initSettings();
    initAskAi();
    initFilterChips();
    initClientSearch();
    showView(VIEWS.DASHBOARD);
    initRefreshButton();
    initVisibilityRefresh();
    loadData();
  }

  document.addEventListener('DOMContentLoaded', init);

  // ============================================================
  // SECTION 10: GOOGLE SHEETS â€” FETCH
  // ============================================================

  async function fetchSheetData() {
    const url =
      'https://sheets.googleapis.com/v4/spreadsheets/' +
      encodeURIComponent(SHEET_ID) +
      '/values/A:K?key=' +
      encodeURIComponent(SHEETS_API_KEY);

    const response = await fetch(url);

    if (!response.ok) {
      if (response.status === 400) throw new Error('Invalid Sheet ID â€” check the SHEET_ID value.');
      if (response.status === 403) throw new Error('Access denied â€” check API key or sheet sharing settings.');
      if (response.status === 404) throw new Error('Sheet not found â€” verify the Sheet ID is correct.');
      if (response.status === 429) throw new Error('Rate limit reached â€” wait a moment and try again.');
      throw new Error('Server error (' + response.status + ') â€” try again later.');
    }

    const json = await response.json();

    if (!json.values || json.values.length === 0) {
      throw new Error('The sheet appears to be empty.');
    }

    return json.values; // Array of arrays: [[col_A, col_B, ...], ...]
  }

  // ============================================================
  // SECTION 11: GOOGLE SHEETS â€” PARSE
  // ============================================================

  function parseClients(rows) {
    return rows
      .slice(1) // skip header row
      .filter(row => (row[0] || '').trim() !== '') // skip blank rows
      .map(row => {
        const cell = (i) => (row[i] || '').trim();

        const parseMoney = (i) => {
          const n = parseFloat(cell(i).replace(/[$,]/g, ''));
          return isNaN(n) ? 0 : n;
        };

        const parseBool = (i) => { const v = cell(i).toLowerCase(); return v === 'yes' || v === 'y'; };

        return {
          name:             cell(0),
          paymentStatus:    cell(1),
          paymentAmount:    parseMoney(2),
          amountPaid:       parseMoney(3),
          paymentDate:      cell(4),
          isReturning:      parseBool(5),
          wasLastYear:      parseBool(6),
          extensionNeeded:  parseBool(7),
          extensionFiled:   parseBool(8),
          extendedDeadline: cell(9),
          notes:            cell(10),
        };
      });
  }

  // ============================================================
  // SECTION 12: DATA ORCHESTRATION
  // ============================================================

  async function loadData() {
    if (isFetching) return;
    isFetching = true;
    setDataStatus('loading');

    try {
      const rows = await fetchSheetData();
      clientData = parseClients(rows);
      lastSynced = new Date();
      setDataStatus('idle');
      updateLastSyncedUI();

      renderDashboard();
      renderClientList();

    } catch (err) {
      console.error('[RTS] loadData failed:', err);
      setDataStatus('error', err.message);
    } finally {
      isFetching = false;
    }
  }

  function setDataStatus(state, message) {
    const banner  = document.getElementById('data-status-banner');
    const spinner = document.getElementById('status-spinner');
    const text    = document.getElementById('status-text');
    const btn     = document.getElementById('refresh-btn');

    if (!banner) return;
    banner.classList.remove('loading', 'error');

    if (state === 'loading') {
      banner.classList.add('loading');
      if (spinner) spinner.style.display = '';
      if (text)    text.textContent = 'Refreshing client data...';
      if (btn)     btn.disabled = true;
    } else if (state === 'error') {
      banner.classList.add('error');
      if (spinner) spinner.style.display = 'none';
      if (text)    text.textContent = message || 'Could not load data.';
      if (btn)     btn.disabled = false;
    } else {
      // idle â€” hide the banner
      if (spinner) spinner.style.display = 'none';
      if (btn)     btn.disabled = false;
    }
  }

  function updateLastSyncedUI() {
    const timeStr = lastSynced
      ? 'Today at ' + lastSynced.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      : 'â€”';

    // "Last Synced" value in Settings â†’ Data Source group
    const syncEl = document.querySelector('#view-settings .about-row:nth-child(2) .about-value');
    if (syncEl) syncEl.textContent = timeStr;

    // "Google Sheet" status in Settings â†’ Data Source group
    const sheetEl = document.querySelector('#view-settings .about-row:first-child .about-value');
    if (sheetEl) sheetEl.textContent = clientData.length + ' clients loaded';
  }

  function initRefreshButton() {
    document.getElementById('refresh-btn')
      ?.addEventListener('click', () => loadData());
  }

  function initVisibilityRefresh() {
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') loadData();
    });
  }

  // ============================================================
  // SECTION 13: DASHBOARD RENDERING
  // ============================================================

  function renderDashboard() {
    if (!clientData.length) return;

    const totalClients = clientData.length;
    const collected    = clientData.reduce((s, c) => s + c.amountPaid, 0);
    const outstanding  = clientData.reduce((s, c) => s + Math.max(0, c.paymentAmount - c.amountPaid), 0);
    const extensions   = clientData.filter(c => c.extensionNeeded && !c.extensionFiled).length;
    const paidCount    = clientData.filter(c => c.paymentStatus.toLowerCase() === 'paid').length;
    const returning    = clientData.filter(c => c.isReturning).length;
    const newClients   = clientData.filter(c => !c.isReturning).length;
    const notReturned  = clientData.filter(c => c.wasLastYear && !c.isReturning).length;
    const progressPct  = totalClients > 0 ? Math.round((paidCount / totalClients) * 100) : 0;

    const fmt = (n) => '$' + Math.round(n).toLocaleString('en-US');

    setText('metric-total',           totalClients);
    setText('metric-collected',       fmt(collected));
    setText('metric-outstanding',     fmt(outstanding));
    setText('metric-extensions',      extensions);
    setText('progress-label',         paidCount + ' of ' + totalClients + ' returns paid â€” ' + progressPct + '%');
    setText('retention-returning',    returning);
    setText('retention-new',          newClients);
    setText('retention-not-returned', notReturned || 'â€”');

    const fill = document.getElementById('progress-fill');
    if (fill) fill.style.width = progressPct + '%';

    renderActivityList();
  }

  function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  }

  function renderActivityList() {
    const container = document.getElementById('activity-list');
    if (!container) return;

    const withDate = clientData
      .filter(c => c.paymentDate)
      .sort((a, b) => b.paymentDate.localeCompare(a.paymentDate))
      .slice(0, 5);

    if (withDate.length === 0) {
      container.innerHTML = '<div class="list-row"><span class="row-name" style="color:var(--text-secondary)">No recent activity</span></div>';
      return;
    }

    container.innerHTML = withDate.map(c => `
      <div class="list-row">
        <div>
          <div class="row-name">${escHtml(c.name)}</div>
          <div class="row-meta">${escHtml(c.paymentDate)}</div>
        </div>
        ${statusBadge(c.paymentStatus)}
      </div>`).join('');
  }

  function statusBadge(status) {
    const s = (status || '').toLowerCase();
    if (s === 'paid')    return '<span class="badge badge-paid">Paid</span>';
    if (s === 'unpaid')  return '<span class="badge badge-unpaid">Unpaid</span>';
    if (s === 'partial') return '<span class="badge badge-partial">Partial</span>';
    return '<span class="badge badge-filed">' + escHtml(status) + '</span>';
  }

  function escHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  // ============================================================
  // SECTION 14: CLIENT LIST RENDERING
  // ============================================================

  function renderClientList() {
    const container = document.getElementById('client-list-container');
    if (!container) return;

    const query = (document.getElementById('client-search-input')?.value || '').trim().toLowerCase();

    // 1. Filter by active chip
    let filtered = clientData.filter(c => {
      switch (activeFilter) {
        case 'unpaid':    return c.paymentStatus.toLowerCase() === 'unpaid';
        case 'amendment': return c.extensionNeeded;
        case 'returning': return c.isReturning;
        case 'new':       return !c.isReturning;
        default:          return true;
      }
    });

    // 2. Filter by search query
    if (query) {
      filtered = filtered.filter(c => c.name.toLowerCase().includes(query));
    }

    // 3. Sort alphabetically
    filtered.sort((a, b) => a.name.localeCompare(b.name));

    // 4. Empty state
    if (filtered.length === 0) {
      container.innerHTML = `
        <div style="padding:48px 20px;text-align:center;color:var(--text-secondary);font-size:15px;">
          No clients match your search.
        </div>`;
      return;
    }

    // 5. Group by first letter and render
    const groups = {};
    filtered.forEach(c => {
      const letter = (c.name[0] || '#').toUpperCase();
      if (!groups[letter]) groups[letter] = [];
      groups[letter].push(c);
    });

    container.innerHTML = Object.keys(groups).sort().map(letter => `
      <div class="alpha-header">${escHtml(letter)}</div>
      <div class="client-list">
        ${groups[letter].map(c => {
          const sub = (c.isReturning ? 'Returning' : 'New') + ' Â· ' + (c.paymentStatus || 'â€”');
          return `
          <div class="client-row">
            <div class="client-info">
              <div class="client-name">${escHtml(c.name)}</div>
              <div class="client-sub">${escHtml(sub)}</div>
            </div>
            ${statusBadge(c.paymentStatus)}
            <span class="client-chevron">â€º</span>
          </div>`;
        }).join('')}
      </div>`).join('');
  }
</script>

</body>
</html>
